<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Siswa - ICT Taskflow</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; padding: 2rem; }
        .container { max-width: 800px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .task-item { border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }
        .task-item h3 { margin-top: 0; }
        .submit-btn { background-color: #28a745; color: white; padding: 0.5rem; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;}
        .submitted-status { background-color: #6c757d; color: white; padding: 0.5rem; border: none; border-radius: 4px; margin-top: 1rem; display: inline-block;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Tugas Anda</h1>
        <div id="taskList">Memuat tugas...</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // KONFIGURASI FIREBASE ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyBvrReO-C31hWc0w3OniTjJ-s0N0n9cPy8",
            authDomain: "ict-taskflow.firebaseapp.com",
            databaseURL: "https://ict-taskflow-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ict-taskflow",
            storageBucket: "ict-taskflow.appspot.com",
            messagingSenderId: "546834422831",
            appId: "1:546834422831:web:53d11b2e126d138bf1fada",
            measurementId: "G-JC52GWE4LQ"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        const taskListDiv = document.getElementById('taskList');

        auth.onAuthStateChanged(user => {
            if (user) {
                loadTasks(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        function loadTasks(studentId) {
            const assignmentsRef = db.ref('assignments');
            const submissionsRef = db.ref('submissions').orderByChild('studentId').equalTo(studentId);

            submissionsRef.on('value', subSnapshot => {
                const studentSubmissions = subSnapshot.val() || {};
                const submittedTaskIds = Object.values(studentSubmissions).map(sub => sub.assignmentId);

                assignmentsRef.on('value', (assignSnapshot) => {
                    taskListDiv.innerHTML = '';
                    const assignments = assignSnapshot.val();
                    if (assignments) {
                        for (let taskId in assignments) {
                            const task = assignments[taskId];
                            const taskElement = document.createElement('div');
                            taskElement.classList.add('task-item');
                            
                            let actionElement = '';
                            if (submittedTaskIds.includes(taskId)) {
                                actionElement = `<div class="submitted-status">Sudah Dikumpulkan</div>`;
                            } else {
                                actionElement = `<button class="submit-btn" onclick="submitTask('${taskId}')">Kumpulkan Tugas</button>`;
                            }

                            taskElement.innerHTML = `
                                <h3>${task.title}</h3>
                                <p>${task.description}</p>
                                <small>Tenggat: ${task.dueDate}</small>
                                ${actionElement}
                            `;
                            taskListDiv.appendChild(taskElement);
                        }
                    } else {
                        taskListDiv.innerHTML = '<p>Hore, tidak ada tugas!</p>';
                    }
                });
            });
        }

        function submitTask(taskId) {
            const currentUser = auth.currentUser;
            
            const submissionLink = prompt(
                "Langkah 1: Upload tugas Anda ke Google Drive.\n" +
                "Langkah 2: Klik 'Share' dan setel ke 'Anyone with the link'.\n" +
                "Langkah 3: Salin dan tempel link-nya di bawah ini:",
                "https://"
            );

            if (submissionLink && submissionLink !== "https://") {
                const submissionData = {
                    assignmentId: taskId,
                    studentId: currentUser.uid,
                    submissionLink: submissionLink,
                    submittedAt: firebase.database.ServerValue.TIMESTAMP
                };

                db.ref('submissions').push(submissionData)
                    .then(() => alert("Tugas berhasil dikumpulkan!"))
                    .catch(e => alert("Gagal mengumpulkan: " + e.message));
            }
        }
    </script>
</body>
</html>