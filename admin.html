<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT Taskflow - Panel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, child, push, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBvrReO-C31hWc0w3OniTjJ-s0N0n9cPy8",
            authDomain: "ict-taskflow.firebaseapp.com",
            databaseURL: "https://ict-taskflow-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ict-taskflow",
            storageBucket: "ict-taskflow.firebasestorage.app",
            messagingSenderId: "546834422831",
            appId: "1:546834422831:web:53d11b2e126d138bf1fada",
            measurementId: "G-JC52GWE4LQ"
        };
        
        let app, database;
        let connectionStatus = 'connecting';
        let retryCount = 0;
        const maxRetries = 5;
        
        // Connection status indicator
        function updateConnectionStatus(status) {
            connectionStatus = status;
            
            const indicator = document.getElementById('connectionStatus');
            if (indicator) {
                switch(status) {
                    case 'connected':
                        indicator.innerHTML = '<i class="fas fa-cloud text-green-600 mr-1"></i><span class="text-green-600 text-sm">Terhubung ke Firebase</span>';
                        break;
                    case 'connecting':
                        indicator.innerHTML = '<i class="fas fa-spinner fa-spin text-yellow-600 mr-1"></i><span class="text-yellow-600 text-sm">Menghubungkan...</span>';
                        break;
                    case 'offline':
                        indicator.innerHTML = '<i class="fas fa-wifi-slash text-orange-600 mr-1"></i><span class="text-orange-600 text-sm">Mode Demo</span>';
                        break;
                    case 'error':
                        indicator.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 mr-1"></i><span class="text-red-600 text-sm">Koneksi Bermasalah</span>';
                        break;
                }
            }
        }
        
        // Initialize Firebase with retry mechanism
        async function initializeFirebase() {
            try {
                updateConnectionStatus('connecting');
                
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                
                // Test connection
                const testRef = ref(database, '.info/connected');
                onValue(testRef, (snapshot) => {
                    if (snapshot.val() === true) {
                        updateConnectionStatus('connected');
                        console.log('‚úÖ Firebase connected successfully');
                        retryCount = 0;
                        
                        // Load existing data when connected
                        loadExistingData();
                    } else {
                        updateConnectionStatus('offline');
                        console.log('‚ö†Ô∏è Firebase disconnected');
                    }
                });
                
                // Make Firebase functions globally available
                window.firebaseDB = {
                    database,
                    ref,
                    set: async (ref, value) => {
                        try {
                            await set(ref, value);
                            return true;
                        } catch (error) {
                            console.error('Firebase set error:', error);
                            throw error;
                        }
                    },
                    get: async (ref) => {
                        try {
                            return await get(ref);
                        } catch (error) {
                            console.error('Firebase get error:', error);
                            throw error;
                        }
                    },
                    child,
                    push,
                    onValue,
                    remove: async (ref) => {
                        try {
                            await remove(ref);
                            return true;
                        } catch (error) {
                            console.error('Firebase remove error:', error);
                            throw error;
                        }
                    }
                };
                
                // Initialize the app
                window.initializeApp();
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateConnectionStatus('error');
                
                if (retryCount < maxRetries) {
                    retryCount++;
                    console.log(`üîÑ Retrying Firebase connection (${retryCount}/${maxRetries})...`);
                    setTimeout(initializeFirebase, 2000 * retryCount);
                } else {
                    console.log('üî¥ Max retries reached, switching to offline mode');
                    updateConnectionStatus('offline');
                    window.initializeApp();
                }
            }
        }
        
        // Load existing data from Firebase
        async function loadExistingData() {
            if (!window.firebaseDB || connectionStatus !== 'connected') return;
            
            try {
                const { database, ref, get } = window.firebaseDB;
                
                // Load assignments
                const assignmentsSnapshot = await get(ref(database, 'assignments'));
                if (assignmentsSnapshot.exists()) {
                    const assignmentsData = assignmentsSnapshot.val();
                    allAssignments = Object.entries(assignmentsData).map(([key, value]) => ({
                        id: key,
                        ...value
                    }));
                    console.log(`üìö Loaded ${allAssignments.length} assignments from Firebase`);
                } else {
                    // Initialize with demo assignments if none exist
                    await initializeDemoAssignments();
                }
                
                // Load users
                const usersSnapshot = await get(ref(database, 'users'));
                if (usersSnapshot.exists()) {
                    const usersData = usersSnapshot.val();
                    allUsers = Object.entries(usersData).map(([key, value]) => ({
                        username: key,
                        ...value
                    }));
                    console.log(`üë• Loaded ${allUsers.length} users from Firebase`);
                } else {
                    // Initialize with demo users if none exist
                    await initializeDemoUsers();
                }
                
                // Load submissions
                const submissionsSnapshot = await get(ref(database, 'submissions'));
                if (submissionsSnapshot.exists()) {
                    allSubmissions = submissionsSnapshot.val();
                    console.log(`üìù Loaded submissions from Firebase`);
                }
                
                // Refresh UI if admin is logged in
                if (currentAdmin) {
                    loadDashboardData();
                    if (currentSection) {
                        showSection(currentSection);
                    }
                }
                
            } catch (error) {
                console.error('Error loading existing data:', error);
            }
        }
        
        // Initialize demo assignments in Firebase
        async function initializeDemoAssignments() {
            if (!window.firebaseDB || connectionStatus !== 'connected') return;
            
            try {
                const { database, ref, set } = window.firebaseDB;
                
                const demoAssignments = {
                    'assignment_1': {
                        title: 'Tugas Matematika Bab 1',
                        subject: 'Matematika',
                        description: 'Kerjakan soal-soal pada halaman 25-30 tentang aljabar dasar',
                        dueDate: '2024-02-15',
                        createdAt: '2024-02-01T08:00:00Z',
                        targetClass: '9A'
                    },
                    'assignment_2': {
                        title: 'Essay Bahasa Indonesia',
                        subject: 'Bahasa Indonesia',
                        description: 'Tulis essay tentang lingkungan hidup minimal 500 kata',
                        dueDate: '2024-02-20',
                        createdAt: '2024-02-02T10:30:00Z',
                        targetClass: '9A'
                    },
                    'assignment_3': {
                        title: 'Praktikum IPA',
                        subject: 'IPA',
                        description: 'Laporan hasil percobaan tentang fotosintesis',
                        dueDate: '2024-02-25',
                        createdAt: '2024-02-03T13:45:00Z',
                        targetClass: '9B'
                    }
                };
                
                await set(ref(database, 'assignments'), demoAssignments);
                
                // Update local assignments
                allAssignments = Object.entries(demoAssignments).map(([key, value]) => ({
                    id: key,
                    ...value
                }));
                
                console.log('‚úÖ Demo assignments initialized in Firebase');
                
            } catch (error) {
                console.error('Error initializing demo assignments:', error);
            }
        }
        
        // Initialize demo users in Firebase
        async function initializeDemoUsers() {
            if (!window.firebaseDB || connectionStatus !== 'connected') return;
            
            try {
                const { database, ref, set } = window.firebaseDB;
                
                const demoUsers = {
                    'andi123': {
                        username: 'andi123',
                        password: 'password123',
                        fullName: 'Andi Pratama',
                        class: '9A',
                        registeredAt: '2024-01-15T08:00:00Z'
                    },
                    'sari456': {
                        username: 'sari456',
                        password: 'password123',
                        fullName: 'Sari Dewi',
                        class: '9A',
                        registeredAt: '2024-01-16T09:30:00Z'
                    },
                    'budi789': {
                        username: 'budi789',
                        password: 'password123',
                        fullName: 'Budi Santoso',
                        class: '9B',
                        registeredAt: '2024-01-17T10:15:00Z'
                    }
                };
                
                await set(ref(database, 'users'), demoUsers);
                
                // Update local users
                allUsers = Object.entries(demoUsers).map(([key, value]) => ({
                    username: key,
                    ...value
                }));
                
                console.log('‚úÖ Demo users initialized in Firebase');
                
            } catch (error) {
                console.error('Error initializing demo users:', error);
            }
        }
        
        // Auto-retry connection on network changes
        window.addEventListener('online', () => {
            console.log('üåê Network back online, retrying Firebase connection...');
            retryCount = 0;
            initializeFirebase();
        });
        
        window.addEventListener('offline', () => {
            console.log('üì¥ Network offline detected');
            updateConnectionStatus('offline');
        });
        
        // Start initialization
        initializeFirebase();
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #dc2626; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sidebar-active { background-color: #fef2f2; color: #dc2626; border-right: 3px solid #dc2626; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="min-h-screen gradient-bg flex items-center justify-center">
        <div class="text-center text-white">
            <div class="loading mx-auto mb-4"></div>
            <p>Memuat Panel Admin...</p>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="adminLogin" class="hidden min-h-screen gradient-bg">
        <div class="container mx-auto px-4 py-8">
            <!-- Header -->
            <div class="text-center mb-12">
                <div class="bg-white w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 card-shadow">
                    <i class="fas fa-user-shield text-red-600 text-4xl"></i>
                </div>
                <h1 class="text-4xl font-bold text-white mb-4">Panel Admin</h1>
                <p class="text-red-100 text-lg">ICT Taskflow Management System</p>
            </div>

            <!-- Login Card -->
            <div class="max-w-md mx-auto">
                <div class="bg-white rounded-2xl card-shadow p-8 animate-fade-in">
                    <div class="text-center mb-8">
                        <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-lock text-red-600 text-2xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Login Admin</h2>
                        <p class="text-gray-600">Akses panel administrasi sistem</p>
                    </div>
                    
                    <form id="adminLoginForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username Admin</label>
                            <input type="text" id="adminUsername" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all"
                                   placeholder="Masukkan username admin">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="adminPassword" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all"
                                   placeholder="Masukkan password admin">
                        </div>
                        
                        <button type="submit" id="adminLoginBtn"
                                class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            Masuk ke Panel Admin
                        </button>
                    </form>
                    
                    <!-- Demo Credentials -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 mb-2"><strong>Demo Credentials:</strong></p>
                        <p class="text-xs text-gray-500">Username: <code>admin</code></p>
                        <p class="text-xs text-gray-500">Password: <code>admin123</code></p>
                    </div>
                    
                    <!-- Connection Status -->
                    <div class="mt-6 text-center">
                        <div id="connectionStatus" class="flex items-center justify-center">
                            <i class="fas fa-spinner fa-spin text-yellow-600 mr-1"></i>
                            <span class="text-yellow-600 text-sm">Menghubungkan...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back to Student -->
            <div class="text-center mt-12">
                <a href="index.html" 
                   class="inline-flex items-center bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-6 py-3 rounded-lg transition-all backdrop-blur-sm">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Kembali ke Dashboard Siswa
                </a>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <div class="bg-red-100 w-10 h-10 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-user-shield text-red-600"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-semibold text-gray-800">ICT Taskflow Admin</h1>
                            <p class="text-xs text-gray-500">Panel Administrasi</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-800" id="adminName">Administrator</p>
                            <p class="text-xs text-gray-500">Super Admin</p>
                        </div>
                        
                        <button onclick="adminLogout()" 
                                class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <aside class="w-64 bg-white shadow-sm min-h-screen">
                <nav class="mt-8">
                    <div class="px-4 space-y-2">
                        <button onclick="showSection('dashboard')" id="nav-dashboard"
                                class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors sidebar-active">
                            <i class="fas fa-tachometer-alt mr-3"></i>
                            Dashboard
                        </button>
                        <button onclick="showSection('assignments')" id="nav-assignments"
                                class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-tasks mr-3"></i>
                            Kelola Tugas
                        </button>
                        <button onclick="showSection('students')" id="nav-students"
                                class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-users mr-3"></i>
                            Data Siswa
                        </button>
                        <button onclick="showSection('submissions')" id="nav-submissions"
                                class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-file-alt mr-3"></i>
                            Pengumpulan
                        </button>
                        <button onclick="showSection('reports')" id="nav-reports"
                                class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-chart-bar mr-3"></i>
                            Laporan
                        </button>
                    </div>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8">
                <!-- Dashboard Section -->
                <div id="section-dashboard" class="section-content">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Dashboard Admin üìä</h2>
                        <p class="text-gray-600">Ringkasan sistem ICT Taskflow</p>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl card-shadow p-6">
                            <div class="flex items-center">
                                <div class="bg-blue-100 w-12 h-12 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-tasks text-blue-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Total Tugas</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalAssignments">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl card-shadow p-6">
                            <div class="flex items-center">
                                <div class="bg-green-100 w-12 h-12 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-green-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Total Siswa</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalStudents">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl card-shadow p-6">
                            <div class="flex items-center">
                                <div class="bg-yellow-100 w-12 h-12 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-alt text-yellow-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Pengumpulan</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalSubmissions">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl card-shadow p-6">
                            <div class="flex items-center">
                                <div class="bg-red-100 w-12 h-12 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-600">Terlambat</p>
                                    <p class="text-2xl font-bold text-gray-800" id="overdueSubmissions">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl card-shadow">
                            <div class="p-6 border-b">
                                <h3 class="text-lg font-semibold text-gray-800">Tugas Terbaru</h3>
                            </div>
                            <div class="p-6">
                                <div id="recentAssignments" class="space-y-4">
                                    <!-- Recent assignments will be loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl card-shadow">
                            <div class="p-6 border-b">
                                <h3 class="text-lg font-semibold text-gray-800">Pengumpulan Terbaru</h3>
                            </div>
                            <div class="p-6">
                                <div id="recentSubmissions" class="space-y-4">
                                    <!-- Recent submissions will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assignments Section -->
                <div id="section-assignments" class="section-content hidden">
                    <div class="mb-8">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 mb-2">Kelola Tugas üìù</h2>
                                <p class="text-gray-600">Buat dan kelola tugas untuk siswa</p>
                            </div>
                            <button onclick="openCreateAssignmentModal()" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>
                                Buat Tugas Baru
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl card-shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-800">Daftar Tugas</h3>
                                <select id="filterClass" onchange="filterAssignmentsByClass()" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="">Semua Kelas</option>
                                    <option value="7A">7A</option>
                                    <option value="7B">7B</option>
                                    <option value="8A">8A</option>
                                    <option value="8B">8B</option>
                                    <option value="9A">9A</option>
                                    <option value="9B">9B</option>
                                    <option value="9C">9C</option>
                                </select>
                            </div>
                        </div>
                        <div class="p-6">
                            <div id="assignmentsList" class="space-y-4">
                                <!-- Assignments will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Section -->
                <div id="section-students" class="section-content hidden">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Data Siswa üë•</h2>
                        <p class="text-gray-600">Kelola data siswa yang terdaftar</p>
                    </div>

                    <div class="bg-white rounded-xl card-shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-800">Daftar Siswa</h3>
                                <select id="filterStudentClass" onchange="filterStudentsByClass()" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="">Semua Kelas</option>
                                    <option value="7A">7A</option>
                                    <option value="7B">7B</option>
                                    <option value="8A">8A</option>
                                    <option value="8B">8B</option>
                                    <option value="9A">9A</option>
                                    <option value="9B">9B</option>
                                    <option value="9C">9C</option>
                                </select>
                            </div>
                        </div>
                        <div class="p-6">
                            <div id="studentsList" class="space-y-4">
                                <!-- Students will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submissions Section -->
                <div id="section-submissions" class="section-content hidden">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Pengumpulan Tugas üìÑ</h2>
                        <p class="text-gray-600">Monitor pengumpulan tugas siswa</p>
                    </div>

                    <div class="bg-white rounded-xl card-shadow">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-800">Daftar Pengumpulan</h3>
                                <select id="filterSubmissionAssignment" onchange="filterSubmissionsByAssignment()" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="">Semua Tugas</option>
                                </select>
                            </div>
                        </div>
                        <div class="p-6">
                            <div id="submissionsList" class="space-y-4">
                                <!-- Submissions will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="section-reports" class="section-content hidden">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Laporan Sistem üìä</h2>
                        <p class="text-gray-600">Analisis dan statistik penggunaan sistem</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl card-shadow">
                            <div class="p-6 border-b">
                                <h3 class="text-lg font-semibold text-gray-800">Statistik Kelas</h3>
                            </div>
                            <div class="p-6">
                                <div id="classStats" class="space-y-4">
                                    <!-- Class statistics will be loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl card-shadow">
                            <div class="p-6 border-b">
                                <h3 class="text-lg font-semibold text-gray-800">Tingkat Pengumpulan</h3>
                            </div>
                            <div class="p-6">
                                <div id="submissionStats" class="space-y-4">
                                    <!-- Submission statistics will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Assignment Modal -->
    <div id="createAssignmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl max-w-md w-full p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-800">Buat Tugas Baru</h3>
                <button onclick="closeCreateAssignmentModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="createAssignmentForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Judul Tugas</label>
                    <input type="text" id="assignmentTitle" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                           placeholder="Masukkan judul tugas">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                    <select id="assignmentSubject" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        <option value="">Pilih Mata Pelajaran</option>
                        <option value="Matematika">Matematika</option>
                        <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                        <option value="Bahasa Inggris">Bahasa Inggris</option>
                        <option value="IPA">IPA</option>
                        <option value="IPS">IPS</option>
                        <option value="PKN">PKN</option>
                        <option value="Seni Budaya">Seni Budaya</option>
                        <option value="PJOK">PJOK</option>
                        <option value="Prakarya">Prakarya</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas Target</label>
                    <select id="assignmentClass" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        <option value="">Pilih Kelas</option>
                        <option value="7A">7A</option>
                        <option value="7B">7B</option>
                        <option value="8A">8A</option>
                        <option value="8B">8B</option>
                        <option value="9A">9A</option>
                        <option value="9B">9B</option>
                        <option value="9C">9C</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi Tugas</label>
                    <textarea id="assignmentDescription" rows="3" required 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                              placeholder="Jelaskan detail tugas yang harus dikerjakan..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Deadline</label>
                    <input type="date" id="assignmentDueDate" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeCreateAssignmentModal()" 
                            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg transition-colors">
                        Batal
                    </button>
                    <button type="submit" id="createAssignmentBtn"
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        Buat Tugas
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Submission Modal -->
    <div id="viewSubmissionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl max-w-lg w-full p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-800">Detail Pengumpulan</h3>
                <button onclick="closeViewSubmissionModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="submissionDetails" class="space-y-4">
                <!-- Submission details will be loaded here -->
            </div>
            
            <div class="flex justify-end pt-4">
                <button onclick="closeViewSubmissionModal()" 
                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg transition-colors">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let firebaseReady = false;
        let currentAdmin = null;
        let currentSection = 'dashboard';
        let allAssignments = [];
        let allUsers = [];
        let allSubmissions = {};

        // Initialize app when Firebase is ready
        window.initializeApp = function() {
            firebaseReady = (connectionStatus === 'connected');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('adminLogin').classList.remove('hidden');
            
            // Load demo data as fallback
            if (!firebaseReady || connectionStatus === 'offline') {
                console.log('üîÑ Loading demo data as fallback...');
                loadDemoData();
            }
        };

        // Load demo data
        function loadDemoData() {
            allAssignments = [
                {
                    id: 'assignment_1',
                    title: 'Tugas Matematika Bab 1',
                    subject: 'Matematika',
                    description: 'Kerjakan soal-soal pada halaman 25-30 tentang aljabar dasar',
                    dueDate: '2024-02-15',
                    createdAt: '2024-02-01T08:00:00Z',
                    targetClass: '9A'
                },
                {
                    id: 'assignment_2',
                    title: 'Essay Bahasa Indonesia',
                    subject: 'Bahasa Indonesia',
                    description: 'Tulis essay tentang lingkungan hidup minimal 500 kata',
                    dueDate: '2024-02-20',
                    createdAt: '2024-02-02T10:30:00Z',
                    targetClass: '9A'
                },
                {
                    id: 'assignment_3',
                    title: 'Praktikum IPA',
                    subject: 'IPA',
                    description: 'Laporan hasil percobaan tentang fotosintesis',
                    dueDate: '2024-02-25',
                    createdAt: '2024-02-03T13:45:00Z',
                    targetClass: '9B'
                }
            ];

            allUsers = [
                {
                    username: 'andi123',
                    fullName: 'Andi Pratama',
                    class: '9A',
                    registeredAt: '2024-01-15T08:00:00Z'
                },
                {
                    username: 'sari456',
                    fullName: 'Sari Dewi',
                    class: '9A',
                    registeredAt: '2024-01-16T09:30:00Z'
                },
                {
                    username: 'budi789',
                    fullName: 'Budi Santoso',
                    class: '9B',
                    registeredAt: '2024-01-17T10:15:00Z'
                }
            ];

            allSubmissions = {
                'andi123': {
                    'assignment_1': {
                        type: 'file',
                        content: 'tugas_matematika_andi.pdf',
                        notes: 'Sudah selesai semua soal',
                        submittedAt: '2024-02-10T14:30:00Z'
                    }
                },
                'sari456': {
                    'assignment_1': {
                        type: 'link',
                        content: 'https://drive.google.com/file/d/abc123',
                        notes: 'Link Google Drive',
                        submittedAt: '2024-02-12T16:45:00Z'
                    },
                    'assignment_2': {
                        type: 'text',
                        content: 'Essay tentang pentingnya menjaga lingkungan hidup untuk generasi mendatang...',
                        notes: 'Draft pertama',
                        submittedAt: '2024-02-18T10:20:00Z'
                    }
                }
            };
        }

        // Admin login form handler
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('adminLoginBtn');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<div class="loading"></div> Memproses...';
            loginBtn.disabled = true;
            
            try {
                const username = document.getElementById('adminUsername').value.trim();
                const password = document.getElementById('adminPassword').value;
                
                // Demo admin credentials
                if (username === 'admin' && password === 'admin123') {
                    currentAdmin = {
                        username: username,
                        name: 'Administrator'
                    };
                    
                    showAdminDashboard();
                    console.log('üéâ Admin login successful!');
                } else {
                    alert('Username atau password admin salah!');
                }
                
            } catch (error) {
                console.error('Admin login error:', error);
                alert('Terjadi kesalahan saat login. Silakan coba lagi.');
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        });

        function showAdminDashboard() {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            
            // Update header info
            document.getElementById('adminName').textContent = currentAdmin.name;
            
            // Load dashboard data
            loadDashboardData();
        }

        function loadDashboardData() {
            updateDashboardStats();
            loadRecentAssignments();
            loadRecentSubmissions();
        }

        function updateDashboardStats() {
            const totalAssignments = allAssignments.length;
            const totalStudents = allUsers.length;
            
            let totalSubmissions = 0;
            let overdueSubmissions = 0;
            
            Object.values(allSubmissions).forEach(userSubmissions => {
                Object.entries(userSubmissions).forEach(([assignmentId, submission]) => {
                    totalSubmissions++;
                    
                    const assignment = allAssignments.find(a => a.id == assignmentId);
                    if (assignment && new Date(submission.submittedAt) > new Date(assignment.dueDate)) {
                        overdueSubmissions++;
                    }
                });
            });
            
            document.getElementById('totalAssignments').textContent = totalAssignments;
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalSubmissions').textContent = totalSubmissions;
            document.getElementById('overdueSubmissions').textContent = overdueSubmissions;
        }

        function loadRecentAssignments() {
            const container = document.getElementById('recentAssignments');
            container.innerHTML = '';
            
            if (allAssignments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada tugas.</p>';
                return;
            }
            
            const recentAssignments = allAssignments
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 3);
            
            recentAssignments.forEach(assignment => {
                const assignmentDiv = document.createElement('div');
                assignmentDiv.className = 'border border-gray-200 rounded-lg p-4';
                assignmentDiv.innerHTML = `
                    <h4 class="font-semibold text-gray-800 mb-1">${assignment.title}</h4>
                    <p class="text-sm text-gray-600 mb-2">${assignment.subject} - Kelas ${assignment.targetClass}</p>
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-calendar-alt mr-1"></i>
                        Deadline: ${new Date(assignment.dueDate).toLocaleDateString('id-ID')}
                    </p>
                `;
                container.appendChild(assignmentDiv);
            });
        }

        function loadRecentSubmissions() {
            const container = document.getElementById('recentSubmissions');
            container.innerHTML = '';
            
            const submissions = [];
            Object.entries(allSubmissions).forEach(([username, userSubmissions]) => {
                Object.entries(userSubmissions).forEach(([assignmentId, submission]) => {
                    const user = allUsers.find(u => u.username === username);
                    const assignment = allAssignments.find(a => a.id == assignmentId);
                    if (user && assignment) {
                        submissions.push({
                            username,
                            user,
                            assignment,
                            submission
                        });
                    }
                });
            });
            
            if (submissions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada pengumpulan.</p>';
                return;
            }
            
            const recentSubmissions = submissions
                .sort((a, b) => new Date(b.submission.submittedAt) - new Date(a.submission.submittedAt))
                .slice(0, 3);
            
            recentSubmissions.forEach(item => {
                const isLate = new Date(item.submission.submittedAt) > new Date(item.assignment.dueDate);
                
                const submissionDiv = document.createElement('div');
                submissionDiv.className = 'border border-gray-200 rounded-lg p-4';
                submissionDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-1">${item.user.fullName}</h4>
                            <p class="text-sm text-gray-600">${item.assignment.title}</p>
                        </div>
                        ${isLate ? 
                            '<span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">Terlambat</span>' :
                            '<span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">Tepat Waktu</span>'
                        }
                    </div>
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        ${new Date(item.submission.submittedAt).toLocaleString('id-ID')}
                    </p>
                `;
                container.appendChild(submissionDiv);
            });
        }

        function showSection(sectionName) {
            currentSection = sectionName;
            
            // Hide all sections
            const sections = document.querySelectorAll('.section-content');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Remove active class from all nav buttons
            const navButtons = document.querySelectorAll('[id^="nav-"]');
            navButtons.forEach(btn => btn.classList.remove('sidebar-active'));
            
            // Show selected section
            document.getElementById(`section-${sectionName}`).classList.remove('hidden');
            document.getElementById(`nav-${sectionName}`).classList.add('sidebar-active');
            
            // Load section-specific data
            if (sectionName === 'assignments') {
                loadAssignments();
            } else if (sectionName === 'students') {
                loadStudents();
            } else if (sectionName === 'submissions') {
                loadSubmissions();
            } else if (sectionName === 'reports') {
                loadReports();
            } else if (sectionName === 'dashboard') {
                loadDashboardData();
            }
        }

        function loadAssignments() {
            const container = document.getElementById('assignmentsList');
            container.innerHTML = '';
            
            if (allAssignments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada tugas. Klik "Buat Tugas Baru" untuk memulai.</p>';
                return;
            }
            
            allAssignments.forEach(assignment => {
                const submissionCount = Object.values(allSubmissions).filter(userSubmissions => 
                    userSubmissions[assignment.id]
                ).length;
                
                const assignmentDiv = document.createElement('div');
                assignmentDiv.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                assignmentDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 mb-1">${assignment.title}</h4>
                            <p class="text-sm text-gray-600 mb-2">${assignment.subject} - Kelas ${assignment.targetClass}</p>
                            <p class="text-sm text-gray-700">${assignment.description}</p>
                        </div>
                        <div class="ml-4 text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${submissionCount} Pengumpulan
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            Deadline: ${new Date(assignment.dueDate).toLocaleDateString('id-ID')}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="viewAssignmentSubmissions('${assignment.id}')" 
                                    class="bg-blue-100 hover:bg-blue-200 text-blue-600 px-3 py-1 rounded text-sm transition-colors">
                                <i class="fas fa-eye mr-1"></i>
                                Lihat Pengumpulan
                            </button>
                            <button onclick="deleteAssignment('${assignment.id}')" 
                                    class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded text-sm transition-colors">
                                <i class="fas fa-trash mr-1"></i>
                                Hapus
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(assignmentDiv);
            });
        }

        function loadStudents() {
            const container = document.getElementById('studentsList');
            container.innerHTML = '';
            
            if (allUsers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada siswa yang terdaftar.</p>';
                return;
            }
            
            allUsers.forEach(user => {
                const userSubmissions = allSubmissions[user.username] || {};
                const submissionCount = Object.keys(userSubmissions).length;
                
                const userDiv = document.createElement('div');
                userDiv.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                userDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 mb-1">${user.fullName}</h4>
                            <p class="text-sm text-gray-600 mb-1">Username: ${user.username}</p>
                            <p class="text-sm text-gray-600">Kelas: ${user.class}</p>
                        </div>
                        <div class="ml-4 text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ${submissionCount} Tugas Dikumpulkan
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            Terdaftar: ${new Date(user.registeredAt).toLocaleDateString('id-ID')}
                        </div>
                        <button onclick="viewStudentSubmissions('${user.username}')" 
                                class="bg-blue-100 hover:bg-blue-200 text-blue-600 px-3 py-1 rounded text-sm transition-colors">
                            <i class="fas fa-eye mr-1"></i>
                            Lihat Aktivitas
                        </button>
                    </div>
                `;
                container.appendChild(userDiv);
            });
        }

        function loadSubmissions() {
            const container = document.getElementById('submissionsList');
            const filterSelect = document.getElementById('filterSubmissionAssignment');
            
            // Populate filter options
            filterSelect.innerHTML = '<option value="">Semua Tugas</option>';
            allAssignments.forEach(assignment => {
                const option = document.createElement('option');
                option.value = assignment.id;
                option.textContent = assignment.title;
                filterSelect.appendChild(option);
            });
            
            container.innerHTML = '';
            
            const submissions = [];
            Object.entries(allSubmissions).forEach(([username, userSubmissions]) => {
                Object.entries(userSubmissions).forEach(([assignmentId, submission]) => {
                    const user = allUsers.find(u => u.username === username);
                    const assignment = allAssignments.find(a => a.id == assignmentId);
                    if (user && assignment) {
                        submissions.push({
                            username,
                            user,
                            assignment,
                            submission,
                            assignmentId
                        });
                    }
                });
            });
            
            if (submissions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada pengumpulan tugas.</p>';
                return;
            }
            
            submissions
                .sort((a, b) => new Date(b.submission.submittedAt) - new Date(a.submission.submittedAt))
                .forEach(item => {
                    const isLate = new Date(item.submission.submittedAt) > new Date(item.assignment.dueDate);
                    
                    const submissionDiv = document.createElement('div');
                    submissionDiv.className = `border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${isLate ? 'bg-yellow-50' : 'bg-white'}`;
                    submissionDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 mb-1">${item.user.fullName} (${item.user.class})</h4>
                                <p class="text-sm text-gray-600 mb-1">${item.assignment.title}</p>
                                <p class="text-sm text-gray-600">${item.assignment.subject}</p>
                            </div>
                            <div class="ml-4">
                                ${isLate ? 
                                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-clock mr-1"></i>Terlambat</span>' :
                                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check mr-1"></i>Tepat Waktu</span>'
                                }
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-calendar-alt mr-1"></i>
                                Dikumpulkan: ${new Date(item.submission.submittedAt).toLocaleString('id-ID')}
                            </div>
                            <button onclick="viewSubmissionDetail('${item.username}', '${item.assignmentId}')" 
                                    class="bg-blue-100 hover:bg-blue-200 text-blue-600 px-3 py-1 rounded text-sm transition-colors">
                                <i class="fas fa-eye mr-1"></i>
                                Lihat Detail
                            </button>
                        </div>
                    `;
                    container.appendChild(submissionDiv);
                });
        }

        function loadReports() {
            loadClassStats();
            loadSubmissionStats();
        }

        function loadClassStats() {
            const container = document.getElementById('classStats');
            container.innerHTML = '';
            
            const classData = {};
            
            allUsers.forEach(user => {
                if (!classData[user.class]) {
                    classData[user.class] = {
                        students: 0,
                        submissions: 0
                    };
                }
                classData[user.class].students++;
                
                const userSubmissions = allSubmissions[user.username] || {};
                classData[user.class].submissions += Object.keys(userSubmissions).length;
            });
            
            Object.entries(classData).forEach(([className, data]) => {
                const classDiv = document.createElement('div');
                classDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                classDiv.innerHTML = `
                    <div>
                        <h4 class="font-semibold text-gray-800">Kelas ${className}</h4>
                        <p class="text-sm text-gray-600">${data.students} siswa</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-blue-600">${data.submissions}</p>
                        <p class="text-xs text-gray-500">pengumpulan</p>
                    </div>
                `;
                container.appendChild(classDiv);
            });
        }

        function loadSubmissionStats() {
            const container = document.getElementById('submissionStats');
            container.innerHTML = '';
            
            allAssignments.forEach(assignment => {
                const submissionCount = Object.values(allSubmissions).filter(userSubmissions => 
                    userSubmissions[assignment.id]
                ).length;
                
                const targetStudents = allUsers.filter(user => user.class === assignment.targetClass).length;
                const percentage = targetStudents > 0 ? Math.round((submissionCount / targetStudents) * 100) : 0;
                
                const assignmentDiv = document.createElement('div');
                assignmentDiv.className = 'p-3 bg-gray-50 rounded-lg';
                assignmentDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold text-gray-800">${assignment.title}</h4>
                        <span class="text-sm font-medium ${percentage >= 80 ? 'text-green-600' : percentage >= 50 ? 'text-yellow-600' : 'text-red-600'}">
                            ${percentage}%
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full ${percentage >= 80 ? 'bg-green-500' : percentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'}" 
                             style="width: ${percentage}%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">${submissionCount}/${targetStudents} siswa</p>
                `;
                container.appendChild(assignmentDiv);
            });
        }

        // Create assignment form handler
        document.getElementById('createAssignmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const createBtn = document.getElementById('createAssignmentBtn');
            const originalText = createBtn.innerHTML;
            createBtn.innerHTML = '<div class="loading"></div> Membuat...';
            createBtn.disabled = true;
            
            try {
                const title = document.getElementById('assignmentTitle').value.trim();
                const subject = document.getElementById('assignmentSubject').value;
                const targetClass = document.getElementById('assignmentClass').value;
                const description = document.getElementById('assignmentDescription').value.trim();
                const dueDate = document.getElementById('assignmentDueDate').value;
                
                if (!title || !subject || !targetClass || !description || !dueDate) {
                    alert('Semua field harus diisi!');
                    return;
                }
                
                const assignmentId = `assignment_${Date.now()}`;
                const newAssignment = {
                    id: assignmentId,
                    title: title,
                    subject: subject,
                    targetClass: targetClass,
                    description: description,
                    dueDate: dueDate,
                    createdAt: new Date().toISOString()
                };
                
                // Save to Firebase if connected
                if (window.firebaseDB && connectionStatus === 'connected') {
                    try {
                        const { database, ref, set } = window.firebaseDB;
                        await set(ref(database, `assignments/${assignmentId}`), newAssignment);
                        console.log('‚úÖ Assignment saved to Firebase');
                    } catch (firebaseError) {
                        console.log('‚ö†Ô∏è Firebase save failed, updating local data only');
                    }
                }
                
                // Update local data
                allAssignments.push(newAssignment);
                
                closeCreateAssignmentModal();
                loadAssignments();
                loadDashboardData();
                
                alert(`Tugas "${title}" berhasil dibuat!`);
                
            } catch (error) {
                console.error('Create assignment error:', error);
                alert('Gagal membuat tugas. Silakan coba lagi.');
            } finally {
                createBtn.innerHTML = originalText;
                createBtn.disabled = false;
            }
        });

        function openCreateAssignmentModal() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('assignmentDueDate').min = today;
            
            document.getElementById('createAssignmentModal').classList.remove('hidden');
        }

        function closeCreateAssignmentModal() {
            document.getElementById('createAssignmentModal').classList.add('hidden');
            document.getElementById('createAssignmentForm').reset();
        }

        function deleteAssignment(assignmentId) {
            if (confirm('Yakin ingin menghapus tugas ini? Semua pengumpulan terkait akan ikut terhapus.')) {
                // Remove from Firebase if connected
                if (window.firebaseDB && connectionStatus === 'connected') {
                    try {
                        const { database, ref, remove } = window.firebaseDB;
                        remove(ref(database, `assignments/${assignmentId}`));
                        console.log('‚úÖ Assignment deleted from Firebase');
                    } catch (firebaseError) {
                        console.log('‚ö†Ô∏è Firebase delete failed, updating local data only');
                    }
                }
                
                // Remove from local data
                allAssignments = allAssignments.filter(a => a.id !== assignmentId);
                
                // Remove related submissions
                Object.keys(allSubmissions).forEach(username => {
                    if (allSubmissions[username][assignmentId]) {
                        delete allSubmissions[username][assignmentId];
                    }
                });
                
                loadAssignments();
                loadDashboardData();
                
                alert('Tugas berhasil dihapus!');
            }
        }

        function viewSubmissionDetail(username, assignmentId) {
            const user = allUsers.find(u => u.username === username);
            const assignment = allAssignments.find(a => a.id == assignmentId);
            const submission = allSubmissions[username][assignmentId];
            
            if (!user || !assignment || !submission) return;
            
            const isLate = new Date(submission.submittedAt) > new Date(assignment.dueDate);
            
            let content = '';
            if (submission.type === 'text') {
                content = `<div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-700">${submission.content}</p>
                </div>`;
            } else if (submission.type === 'link') {
                content = `<div class="bg-gray-50 p-3 rounded-lg">
                    <a href="${submission.content}" target="_blank" rel="noopener noreferrer" 
                       class="text-blue-600 hover:text-blue-800 underline text-sm">
                        ${submission.content}
                    </a>
                </div>`;
            } else if (submission.type === 'file') {
                content = `<div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm text-gray-700">
                        <i class="fas fa-file mr-2"></i>
                        ${submission.content}
                    </p>
                </div>`;
            }
            
            document.getElementById('submissionDetails').innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Informasi Siswa</h4>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm"><strong>Nama:</strong> ${user.fullName}</p>
                            <p class="text-sm"><strong>Username:</strong> ${user.username}</p>
                            <p class="text-sm"><strong>Kelas:</strong> ${user.class}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Informasi Tugas</h4>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm"><strong>Judul:</strong> ${assignment.title}</p>
                            <p class="text-sm"><strong>Mata Pelajaran:</strong> ${assignment.subject}</p>
                            <p class="text-sm"><strong>Deadline:</strong> ${new Date(assignment.dueDate).toLocaleString('id-ID')}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Pengumpulan</h4>
                        ${content}
                        ${submission.notes ? `
                            <div class="mt-2 bg-blue-50 p-3 rounded-lg">
                                <p class="text-sm text-blue-800"><strong>Catatan:</strong> ${submission.notes}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Status Pengumpulan</h4>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm"><strong>Dikumpulkan:</strong> ${new Date(submission.submittedAt).toLocaleString('id-ID')}</p>
                            <p class="text-sm">
                                <strong>Status:</strong> 
                                <span class="${isLate ? 'text-red-600' : 'text-green-600'} font-medium">
                                    ${isLate ? 'Terlambat' : 'Tepat Waktu'}
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('viewSubmissionModal').classList.remove('hidden');
        }

        function closeViewSubmissionModal() {
            document.getElementById('viewSubmissionModal').classList.add('hidden');
        }

        function filterAssignmentsByClass() {
            const filterValue = document.getElementById('filterClass').value;
            const assignmentElements = document.querySelectorAll('#assignmentsList > div');
            
            assignmentElements.forEach((element, index) => {
                const assignment = allAssignments[index];
                const show = !filterValue || assignment.targetClass === filterValue;
                element.style.display = show ? 'block' : 'none';
            });
        }

        function filterStudentsByClass() {
            const filterValue = document.getElementById('filterStudentClass').value;
            const studentElements = document.querySelectorAll('#studentsList > div');
            
            studentElements.forEach((element, index) => {
                const user = allUsers[index];
                const show = !filterValue || user.class === filterValue;
                element.style.display = show ? 'block' : 'none';
            });
        }

        function filterSubmissionsByAssignment() {
            const filterValue = document.getElementById('filterSubmissionAssignment').value;
            const submissionElements = document.querySelectorAll('#submissionsList > div');
            
            submissionElements.forEach(element => {
                if (!filterValue) {
                    element.style.display = 'block';
                } else {
                    const assignmentTitle = element.querySelector('p').textContent;
                    const assignment = allAssignments.find(a => a.title === assignmentTitle);
                    const show = assignment && assignment.id == filterValue;
                    element.style.display = show ? 'block' : 'none';
                }
            });
        }

        function viewAssignmentSubmissions(assignmentId) {
            showSection('submissions');
            
            // Filter submissions by assignment
            setTimeout(() => {
                document.getElementById('filterSubmissionAssignment').value = assignmentId;
                filterSubmissionsByAssignment();
            }, 100);
        }

        function viewStudentSubmissions(username) {
            showSection('submissions');
            
            // Filter submissions by student (custom filter)
            setTimeout(() => {
                const submissionElements = document.querySelectorAll('#submissionsList > div');
                submissionElements.forEach(element => {
                    const studentName = element.querySelector('h4').textContent;
                    const user = allUsers.find(u => u.username === username);
                    const show = user && studentName.includes(user.fullName);
                    element.style.display = show ? 'block' : 'none';
                });
            }, 100);
        }

        function adminLogout() {
            if (confirm('Yakin ingin logout dari panel admin?')) {
                currentAdmin = null;
                
                // Reset forms
                document.getElementById('adminLoginForm').reset();
                
                // Show login screen
                document.getElementById('adminDashboard').classList.add('hidden');
                document.getElementById('adminLogin').classList.remove('hidden');
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98410c743482df78',t:'MTc1ODcwMzk3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
